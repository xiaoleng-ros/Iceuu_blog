# 实施规范化 GitHub 存储与 CDN 加速方案

根据您的详细需求，我们将更新 `Phase 3` 的开发计划，重点重构文件上传与存储逻辑，以符合您的目录规范和性能要求。

## 1. 核心变更点

### A. 目录结构与命名规范 (Refactor)
我们将修改 `app/api/upload/route.ts` 中的路径生成逻辑，严格遵循以下规范：
- **用户头像**: `avatars/[user_uuid].[ext]` (直接使用 Supabase Auth 的 user_id)
- **博客插图**: `posts/[article_id]-[date]/[uuid].[ext]` (支持通过 FormData 传入 `articleId`，若无则使用 `draft-[date]` 作为临时目录)
- **网站资源**: `site/[uuid].[ext]` (或保持原名，视用途而定)
- **命名策略**: 强制使用 `crypto.randomUUID()` 确保文件名唯一性。

### B. CDN 加速集成 (New Feature)
在 `lib/github.ts` 中新增 `getJsDelivrUrl` 方法，替代原有的 `raw.githubusercontent.com` 链接：
- 格式：`https://cdn.jsdelivr.net/gh/${owner}/${repo}@${branch}/${path}`
- 数据库 `media` 表将存储此 CDN 链接，确保前端访问速度。

### C. 增强型 GitHub 工具库 (Update)
更新 `lib/github.ts`：
- 支持 `branch` 参数（默认为 `main`）。
- 优化错误处理，确保上传失败时能返回具体的 GitHub API 错误信息。
- 增加文件大小检查（虽然 API 路由也会做，但双重保障更好）。

## 2. 执行步骤

### Step 1: 重构 GitHub 工具库 (`lib/github.ts`)
- [x] 实现 `getJsDelivrUrl` 函数。
- [x] 优化 `uploadImageToGitHub` 函数，支持更灵活的路径参数。

### Step 2: 升级上传 API (`app/api/upload/route.ts`)
- [x] 解析 FormData 中的 `type` (avatar/post/site) 和 `contextId` (如 article_id)。
- [x] 根据 `type` 实现分流路径生成逻辑：
    - `avatar`: 使用 `user.id` 作为文件名主体。
    - `post`: 组合 `articleId` 和 `YYYYMMDD` 生成目录。
- [x] 集成 CDN URL 生成逻辑。
- [x] 写入数据库 `media` 表。

### Step 3: 验证与测试
- [x] 使用 `curl` 或 Postman 模拟上传请求，验证：
    - 图片是否成功上传到 GitHub 指定目录。
    - 返回的 URL 是否为 jsDelivr CDN 格式。
    - 数据库记录是否正确。

## 3. 后续建议 (暂不包含在本次代码变更中)
- **自动清理**: 建议在项目稳定后，通过 GitHub Actions 配置定期清理脚本（如 `clean-unused-assets.yml`），利用数据库对比文件引用情况。
- **大文件存储**: 目前通过代码逻辑限制上传大小（如 5MB），超大文件建议手动上传到 Supabase Storage。

请确认是否按照此方案执行代码修改？